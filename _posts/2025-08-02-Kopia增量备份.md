---
title: Kopia增量备份
date: 2025-08-02 17:23:00 +0800
categories: [Backup, Kopia]
tags: [kopia]

---



### 1、介绍

本文基于ubuntu24.04，使用kopia + rclone + onedrive的组合，实现个人数据的备份。其具体功用如下：

- kopia：开源全平台增量备份工具，支持多版本控制、端到端加密、压缩、UI界面和命令行等特性。
- rclone：经典备份工具，支持较多存储方式，在此作为连接onedrive的通道使用。
- onedirve：云盘。



### 2、安装

#### 2.1、kopia安装

选择合适版本进行安装即可

```http
https://github.com/kopia/kopia/releases
```

#### 2.2、rclone安装

```bash
sudo -v ; curl https://rclone.org/install.sh | sudo bash
rclone -V
```



### 3、rclone配置

#### 3.1、配置onedrive

由于只需要将rclone作为连接onedrive的通道，因此不考虑其余相关的命令和配置。

(1)：执行 **rclone config** 开启交互式命令

```bash
rclone config
No remotes found, make a new one?
n) New remote
s) Set configuration password
q) Quit config
n/s/q> n

# 输入自定义的远程仓库的名称
Enter name for new remote.
name> onedrive

# 选择仓库的类型，38为onedrive，该数字并非固定不变
Option Storage.
Type of storage to configure.
Choose a number from below, or type in your own value.
 1 / 1Fichier
   \ (fichier)
 2 / Akamai NetStorage
   \ (netstorage)
 3 / Alias for an existing remote
   \ (alias)
 4 / Amazon S3 Compliant Storage Providers including AWS, Alibaba, ArvanCloud, Ceph, ChinaMobile, Cloudflare, DigitalOcean, Dreamhost, Exaba, FlashBlade, GCS, HuaweiOBS, IBMCOS, IDrive, IONOS, LyveCloud, Leviia, Liara, Linode, Magalu, Mega, Minio, Netease, Outscale, Petabox, RackCorp, Rclone, Scaleway, SeaweedFS, Selectel, StackPath, Storj, Synology, TencentCOS, Wasabi, Qiniu and others
   \ (s3)
 5 / Backblaze B2
   \ (b2)
 6 / Better checksums for other remotes
   \ (hasher)
 7 / Box
   \ (box)
 8 / Cache a remote
   \ (cache)
 9 / Citrix Sharefile
   \ (sharefile)
10 / Cloudinary
   \ (cloudinary)
11 / Combine several remotes into one
   \ (combine)
12 / Compress a remote
   \ (compress)
13 / DOI datasets
   \ (doi)
14 / Dropbox
   \ (dropbox)
15 / Encrypt/Decrypt a remote
   \ (crypt)
16 / Enterprise File Fabric
   \ (filefabric)
17 / FTP
   \ (ftp)
18 / FileLu Cloud Storage
   \ (filelu)
19 / Files.com
   \ (filescom)
20 / Gofile
   \ (gofile)
21 / Google Cloud Storage (this is not Google Drive)
   \ (google cloud storage)
22 / Google Drive
   \ (drive)
23 / Google Photos
   \ (google photos)
24 / HTTP
   \ (http)
25 / Hadoop distributed file system
   \ (hdfs)
26 / HiDrive
   \ (hidrive)
27 / ImageKit.io
   \ (imagekit)
28 / In memory object storage system.
   \ (memory)
29 / Internet Archive
   \ (internetarchive)
30 / Jottacloud
   \ (jottacloud)
31 / Koofr, Digi Storage and other Koofr-compatible storage providers
   \ (koofr)
32 / Linkbox
   \ (linkbox)
33 / Local Disk
   \ (local)
34 / Mail.ru Cloud
   \ (mailru)
35 / Mega
   \ (mega)
36 / Microsoft Azure Blob Storage
   \ (azureblob)
37 / Microsoft Azure Files
   \ (azurefiles)
38 / Microsoft OneDrive
   \ (onedrive)
39 / OpenDrive
   \ (opendrive)
40 / OpenStack Swift (Rackspace Cloud Files, Blomp Cloud Storage, Memset Memstore, OVH)
   \ (swift)
41 / Oracle Cloud Infrastructure Object Storage
   \ (oracleobjectstorage)
42 / Pcloud
   \ (pcloud)
43 / PikPak
   \ (pikpak)
44 / Pixeldrain Filesystem
   \ (pixeldrain)
45 / Proton Drive
   \ (protondrive)
46 / Put.io
   \ (putio)
47 / QingCloud Object Storage
   \ (qingstor)
48 / Quatrix by Maytech
   \ (quatrix)
49 / SMB / CIFS
   \ (smb)
50 / SSH/SFTP
   \ (sftp)
51 / Sia Decentralized Cloud
   \ (sia)
52 / Storj Decentralized Cloud Storage
   \ (storj)
53 / Sugarsync
   \ (sugarsync)
54 / Transparently chunk/split large files
   \ (chunker)
55 / Uloz.to
   \ (ulozto)
56 / Union merges the contents of several upstream fs
   \ (union)
57 / Uptobox
   \ (uptobox)
58 / WebDAV
   \ (webdav)
59 / Yandex Disk
   \ (yandex)
60 / Zoho
   \ (zoho)
61 / iCloud Drive
   \ (iclouddrive)
62 / premiumize.me
   \ (premiumizeme)
63 / seafile
   \ (seafile)
Storage> 38

# 客户端id，下文讲述其作用
Option client_id.
OAuth Client Id.
Leave blank normally.
Enter a value. Press Enter to leave empty.
client_id> 
# 客户端密钥，下文讲述其作用
Option client_secret.
OAuth Client Secret.
Leave blank normally.
Enter a value. Press Enter to leave empty.
client_secret> 

# 选择哪个区域的onedrive
Option region.
Choose national cloud region for OneDrive.
Choose a number from below, or type in your own value of type string.
Press Enter for the default (global).
 1 / Microsoft Cloud Global
   \ (global)
 2 / Microsoft Cloud for US Government
   \ (us)
 3 / Microsoft Cloud Germany (deprecated - try global region first).
   \ (de)
 4 / Azure and Office 365 operated by Vnet Group in China
   \ (cn)
region> 1

# 租户id,下文讲述其作用
Option tenant.
ID of the service principals tenant. Also called its directory ID.
Set this if using
- Client Credential flow
Enter a value. Press Enter to leave empty.
tenant>

# 高级设置，如token过期时间、缓存等。一般不需要
Edit advanced config?
y) Yes
n) No (default)
y/n> n

# rclone自动打开浏览器认证界面；如果选n,则提供一个链接，自行复制后访问认证
Use web browser to automatically authenticate rclone with remote?
 * Say Y if the machine running rclone has a web browser you can use
 * Say N if running rclone on a (remote) machine without web browser access
If not sure try Y. If Y failed, try N.

y) Yes (default)
n) No
y/n> y

# 个人或普通商业用户，选1即可
Option config_type.
Type of connection
Choose a number from below, or type in an existing value of type string.
Press Enter for the default (onedrive).
 1 / OneDrive Personal or Business
   \ (onedrive)
 2 / Root Sharepoint site
   \ (sharepoint)
   / Sharepoint site name or URL
 3 | E.g. mysite or https://contoso.sharepoint.com/sites/mysite
   \ (url)
 4 / Search for a Sharepoint site
   \ (search)
 5 / Type in driveID (advanced)
   \ (driveid)
 6 / Type in SiteID (advanced)
   \ (siteid)
   / Sharepoint server-relative path (advanced)
 7 | E.g. /teams/hr
   \ (path)
config_type> 1

# 选择你的onedrive驱动（存储），一般情况下只有1个。第二个有可能是他人共享的目录或者驱动
Option config_driveid.
Select drive you want to use
Choose a number from below, or type in your own value of type string.
Press Enter for the default (xxxxxxx).
 1 / OneDrive (personal)
   \ (xxxxxxx)
 2 / AEEE102E-CFF8-4E2A-89C6-03841FF83500 (personal)
   \ (xxxxxxxx)
config_driveid> 1

# 驱动二次确定，可点击链接查看是否为预想存储位置
Drive OK?

Found drive "root" of type "personal"
URL: https://onedrive.live.com?cid=66d10fec20df80fd&id=01HQTKKO56Y2GOVW7725BZO354PWSELRRZ

y) Yes (default)
n) No
y/n> y

# 配置完成，而后确认即可。
Configuration complete.
Options:
- type: onedrive
- token: {"access_token":"xxxxx","token_type":"Bearer","refresh_token":"xxxx","expiry":"2025-08-02T19:17:08.749143351+08:00","expires_in":3599}
- drive_id: 66d10fec20df80fd
- drive_type: personal
Keep this "onedrive" remote?
y) Yes this is OK (default)
e) Edit this remote
d) Delete this remote
y/e/d> y

# 如无需修改配置，则q退出配置即可
Current remotes:

Name                 Type
====                 ====
onedrive             onedrive

e) Edit existing remote
n) New remote
d) Delete remote
r) Rename remote
c) Copy remote
s) Set configuration password
q) Quit config
e/n/d/r/c/s/q> q
```

(2)：验证配置

```bash
# 查看远程存储
rclone listremotes
# 查看目录
rclone lsd remote-name:
```

#### 3.2、配置详解

(1)：客户端配置

onedrive使用OAuth2进行认证，该认证方式通常需要id和secret。

默认可以留空，rclone已经内置了公共的凭据；如果上传的文件过大或频率过高，则需要申请并使用自己的凭据。

- client_id：OAuth2 应用的唯一标识，代表注册到微软平台的某个应用
- client_secret：与 client_id搭配使用的密钥，用于证明调用方确实拥有该应用的权限

(2)：租户配置

onedrive支持组织架构

- tenant_id：代表某个 Azure AD 组织（租户）的唯一标识。若想使用组织下的存储空间，则需要填写。使用该配置时，需要提供组织下个人用户的client_id和client_secret。



### 4、kopia配置

在开始kopia的配置前，需要说明几个概念

- snapshots：快照。kopia中基本的数据单位（kopia是以快照的形式呈现多版本数据的）
- policies：策略。针对生成快照的策略
- repository：仓库。存储备份数据的位置，如上文的onedrive
- repository-password：仓库密钥，加密与解密的唯一依据，需妥善保存

#### 4.1、kopia连接onedrive

Rclone Remote Path：rclone远程仓库路径。（新设备恢复数据时，该配置需要相同）

```
onedrive: 为rclone配置的远程仓库，格式为 **remotename:**
/kopia-ubuntu：为存储数据的目录
```

Rclone Executable Path：rclone执行文件路径

```
/usr/bin/rclone
```

![image-20250802190830589](https://s2.loli.net/2025/08/02/mzYS8MGwkdZO2XT.png)

#### 4.2、kopia策略详解

针对快照的策略中，**snapshot retention** 和 **scheduling** 为核心配置，二者作用如下

- scheduling：决定什么时候创建快照
- snapshot retention：决定保留哪些快照

其中，kopia的快照保留策略，涉及到最新、小时、日、周、月、年等多种形式，这些配置是以共存的形式存在的，互不冲突。具体策略解释可参考如下文章

```http
https://kopia.discourse.group/t/kopia-snapshot-retention-policies-demystified/2941
```

